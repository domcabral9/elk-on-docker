input {
  udp {
    host => "0.0.0.0"
    port => 5044
  }
}

filter {
  # Adiciona o campo `event.created` com a data de criação do evento.
  mutate {
    add_field => { "[event][created]" => "%{@timestamp}" }
  }

  # Extração inicial usando Grok para capturar o PRI (primeira parte do log, ex.: "<133>")
  grok {
    match => { "message" => "^<%{INT:pri}>" }
    tag_on_failure => ["fortinet_grok_failure"]
  }

  # Se não houver falha no Grok, processa o campo `pri` para obter Facility e Severity
  if "fortinet_grok_failure" not in [tags] {
    ruby {
      code => "
        if event.get('pri')
          pri = event.get('pri').to_i
          facility = pri / 8
          severity = pri % 8
          event.set('[fct][facility]', facility)
          event.set('[fct][severity]', severity)
        end
      "
    }
  }

  # Verifica se o Facility está entre os valores esperados e adiciona tags
  if [fct][facility] == 16 {
    mutate { add_tag => ["local0_facility"] }
  } else if [fct][facility] == 17 {
    mutate { add_tag => ["local1_facility"] }
  } else if [fct][facility] == 18 {
    mutate { add_tag => ["local2_facility"] }
  }

  # Adapta o timestamp do evento
  kv {
    source => "message"
    value_split => "="
    field_split => " "
    whitespace => strict
    target => "fct"
  }

  if ![fct][tz] {
    mutate {
      replace => { "[fct][tz]" => "-0500" }
      add_tag => ["setting_default_timezone"]
    }
  }

  mutate {
    replace => { "[@metadata][timestamp]" => "%{[fct][date]} %{[fct][time]} %{[fct][tz]}" }
  }

  date {
    match => ["[@metadata][timestamp]", "yyyy-MM-dd HH:mm:ss Z"]
    target => "@timestamp"
  }
}

output {
  # Define índices diferentes com base no Facility
  if [fct][facility] == 16 {  # local0
    elasticsearch {
      index => "fortigate-sistema-logs-%{+YYYY.MM.dd}"
      hosts => "${ELASTIC_HOSTS}"
      user => "${ELASTIC_USER}"
      password => "${ELASTIC_PASSWORD}"
      cacert => "certs/ca/ca.crt"
    }
  } else if [fct][facility] == 17 {  # local1
    elasticsearch {
      index => "fortigate-seguranca-logs-%{+YYYY.MM.dd}"
      hosts => "${ELASTIC_HOSTS}"
      user => "${ELASTIC_USER}"
      password => "${ELASTIC_PASSWORD}"
      cacert => "certs/ca/ca.crt"
    }
  } else if [fct][facility] == 18 {  # local2
    elasticsearch {
      index => "fortigate-trafego-logs-%{+YYYY.MM.dd}"
      hosts => "${ELASTIC_HOSTS}"
      user => "${ELASTIC_USER}"
      password => "${ELASTIC_PASSWORD}"
      cacert => "certs/ca/ca.crt"
    }
  }
}
